<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Eco Services - AI Customer Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Demo website container */
        .demo-site {
            background: white;
            width: 90%;
            max-width: 1200px;
            min-height: 600px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        .demo-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .demo-header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .demo-header p {
            color: #666;
            font-size: 1.2em;
        }

        .demo-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .service-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .service-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .service-card p {
            color: #666;
            line-height: 1.6;
        }

        /* 💬 Chat widget styles */
        .chat-widget-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        /* Chat button */
        .chat-button {
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            position: relative;
        }

        .chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }

        .chat-button svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        /* Pulse animation */
        .chat-button::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            animation: pulse 2s infinite;
            z-index: -1;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.3);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* Chat window */
        .chat-window {
            width: 380px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            position: fixed;
            bottom: 110px;
            right: 30px;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chat header */
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .chat-title h4 {
            margin: 0;
            font-size: 16px;
        }

        .chat-title span {
            font-size: 12px;
            opacity: 0.9;
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-button:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Message area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .bot-avatar {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .bot-avatar span {
            font-size: 16px;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .user-message {
            display: flex;
            justify-content: flex-end;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Quick replies */
        .quick-replies {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-button {
            padding: 8px 16px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .quick-button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        /* Input area */
        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        .send-button:hover {
            transform: scale(1.1);
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        /* Typing animation */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 15px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        /* OpenAI Configuration Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .chat-mode-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .mode-button {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-button:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .mode-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .api-config-section {
            display: none;
            margin-top: 20px;
        }

        .api-config-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .info-box {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box h3 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box p {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: transform 0.3s;
        }

        .btn-start:hover {
            transform: translateY(-2px);
        }

        .btn-start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .settings-button {
            position: absolute;
            top: 10px;
            right: 50px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .settings-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            font-size: 12px;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Demo Website Content -->
    <div class="demo-site">
        <div class="demo-header">
            <h1>🌍 Planet Eco Services</h1>
            <p>Your Home Energy Experts - Free Assessment, Government Grants, Professional Installation</p>
        </div>

        <div class="demo-content">
            <div class="service-card">
                <h3>🔥 Free Heating Grants</h3>
                <p>ECO4 government scheme, eligible households can get free central heating system upgrades. Apply for assessment now.</p>
            </div>
            <div class="service-card">
                <h3>☀️ Solar Panel Installation</h3>
                <p>Reduce electricity bills by 70%, 25-year warranty, increase property value, enjoy government green energy subsidies.</p>
            </div>
            <div class="service-card">
                <h3>🏠 Home Insulation Services</h3>
                <p>Professional wall and loft insulation services, reduce heat loss by 35%, significantly lower energy bills.</p>
            </div>
            <div class="service-card">
                <h3>💨 Air Source Heat Pumps</h3>
                <p>Efficient and eco-friendly heating solution, low running costs, government grants up to £7,500.</p>
            </div>
        </div>

        <div style="text-align: center; color: #666;">
            <p>📞 Free Consultation Hotline: 07765556558</p>
            <p>📧 Email: info@planetecoservices.co.uk</p>
        </div>
    </div>

    <!-- 💬 AI Chat Widget -->
    <div class="chat-widget-container">
        <!-- Chat Button -->
        <div class="chat-button" onclick="toggleChat()">
            <svg viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
            </svg>
        </div>

        <!-- Chat Window -->
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-avatar">🤖</div>
                    <div class="chat-title">
                        <h4>Planet Eco AI Assistant</h4>
                        <span id="chatStatus">🟢 Basic Mode</span>
                    </div>
                </div>
                <button class="settings-button" onclick="openSettings()" title="Chat Settings">⚙️</button>
                <button class="close-button" onclick="toggleChat()">×</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <div class="bot-avatar"><span>🤖</span></div>
                    <div class="message-content">
                        👋 Hello! I'm the Planet Eco Services AI assistant.<br><br>
                        I can help you with:<br>
                        • Free heating grant applications<br>
                        • Solar panel installation plans<br>
                        • Home insulation services<br>
                        • Booking a free home energy assessment<br><br>
                        How can I help you today?
                    </div>
                </div>
            </div>

            <div class="quick-replies">
                <button class="quick-button" onclick="sendQuickReply('Learn about free heating grants')">Free Heating Grants</button>
                <button class="quick-button" onclick="sendQuickReply('Solar panel prices')">Solar Panels</button>
                <button class="quick-button" onclick="sendQuickReply('Book free assessment')">Book Assessment</button>
                <button class="quick-button" onclick="sendQuickReply('Contact information')">Contact Us</button>
            </div>

            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type your question..." onkeypress="handleKeyPress(event)">
                <button class="send-button" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🤖 Chat Settings</h2>
                <button class="modal-close" onclick="closeSettings()">×</button>
            </div>
            
            <div class="chat-mode-selector">
                <button class="mode-button active" id="basicMode" onclick="selectChatMode('basic')">
                    <div style="font-size: 24px;">💬</div>
                    <h4>Basic Chat</h4>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">Quick responses, no API needed</p>
                </button>
                <button class="mode-button" id="openaiMode" onclick="selectChatMode('openai')">
                    <div style="font-size: 24px;">🧠</div>
                    <h4>AI Chat (OpenAI)</h4>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">Smart responses, booking support</p>
                </button>
            </div>
            
            <div class="api-config-section" id="apiConfigSection">
                <div class="info-box">
                    <h3>ℹ️ How to get your API Key:</h3>
                    <p>
                        1. Go to <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a><br>
                        2. Sign in or create an account<br>
                        3. Click "Create new secret key"<br>
                        4. Copy the key (starts with sk-)<br>
                        5. Paste it below
                    </p>
                </div>

                <div class="form-group">
                    <label for="apiKey">OpenAI API Key:</label>
                    <input type="password" id="apiKey" placeholder="sk-..." />
                </div>

                <div class="form-group">
                    <label for="model">Model (optional):</label>
                    <input type="text" id="model" value="gpt-4o-2024-08-06" placeholder="gpt-4o-2024-08-06 or gpt-4" />
                </div>
            </div>
            
            <button class="btn-start" onclick="saveChatSettings()">Save Settings</button>
        </div>
    </div>

    <script src="frontend/meeting-booking.js"></script>
    <script>
        // Chat configuration
        let chatMode = 'basic';  // 'basic' or 'openai'
        let apiKey = '';
        let model = 'gpt-4o-2024-08-06';
        let conversationHistory = [];
        let bookingHandler = null;
        let isInBookingFlow = false;

        // Initialize booking handler if available
        if (typeof MeetingBookingHandler !== 'undefined') {
            bookingHandler = new MeetingBookingHandler();
        }

        // System prompt for OpenAI
        const systemPrompt = `You are a helpful AI assistant for Planet Eco Services, a UK-based company specializing in energy-efficient home improvements.

COMPANY OVERVIEW:
- Mission: "Empower a Greener Future" and "positively impact the environment and provide convenience to people"
- Contact: Phone (+44) 07765556558 | Email: info@planetecoservices.co.uk
- Address: Units 2 & 2A Hendham Vale Industrial Park, Vale Park Way, Crumpsall, Manchester M8 0AD

SERVICES: Free Central Heating Grants, Air Source Heat Pumps, Insulation Services (Internal Wall, Loft, Room in Roof)

ECO4 SCHEME: Government grant (NOT a loan) for eligible households to improve energy efficiency

When responding: Be friendly, professional, provide accurate information, encourage free assessments, and emphasize the free nature of grants.`;

        // Knowledge Base for basic mode
        const knowledgeBase = {
            "grant|heating|eco4|free|boiler": {
                response: `🔥 <b>ECO4 Free Heating Grant Scheme</b><br><br>
                Eligibility criteria:<br>
                ✅ Receiving certain government benefits<br>
                ✅ Household income below £31,000<br>
                ✅ Property EPC rating D-G<br><br>
                Services included:<br>
                • Free boiler replacement<br>
                • Central heating system upgrade<br>
                • Smart thermostat installation<br><br>
                📞 Call 07765556558 now for a free assessment!`
            },
            "solar|panel|renewable": {
                response: `☀️ <b>Solar Panel Installation Services</b><br><br>
                Installation benefits:<br>
                ✅ Reduce electricity bills by up to 70%<br>
                ✅ 25-year product warranty<br>
                ✅ Increase property value by 15%<br>
                ✅ Government grants up to £5,000<br><br>
                Return on investment:<br>
                • Average payback in 5-7 years<br>
                • Annual savings £800-1,200<br>
                • Reduce carbon emissions by 2 tons/year<br><br>
                💡 Free home assessment and customized plan!`
            },
            "insulation|wall|loft|cavity": {
                response: `🏠 <b>Professional Insulation Services</b><br><br>
                Service types:<br>
                • Internal wall insulation<br>
                • External wall insulation<br>
                • Loft insulation<br>
                • Floor insulation<br><br>
                Energy saving benefits:<br>
                ✅ Reduce heat loss by 35%<br>
                ✅ Save £300+ on heating bills annually<br>
                ✅ Improve EPC rating<br>
                ✅ Enhanced living comfort<br><br>
                🎁 Eligible households can apply for 100% government grants!`
            },
            "book|survey|assessment|appointment": {
                response: `📋 <b>Book Your Free Home Energy Assessment</b><br><br>
                Assessment includes:<br>
                • Full home energy efficiency check<br>
                • EPC rating evaluation<br>
                • Customized energy-saving plan<br>
                • Grant eligibility review<br><br>
                How to book:<br>
                📞 Phone: 07765556558<br>
                📧 Email: info@planetecoservices.co.uk<br>
                💬 Or reply with your contact details<br><br>
                ⏰ We'll contact you within 24 hours!`
            },
            "contact|phone|address|email|call": {
                response: `📍 <b>Contact Us</b><br><br>
                📞 Free Hotline: 07765556558<br>
                📧 Email: info@planetecoservices.co.uk<br>
                🏢 Address:<br>
                Units 2 & 2A Hendham Vale Industrial Park<br>
                Vale Park Way, Crumpsall<br>
                Manchester M8 0AD<br><br>
                ⏰ Business Hours:<br>
                Monday-Friday 9:00-18:00<br>
                Saturday 10:00-16:00<br><br>
                💬 You can also leave a message here!`
            },
            "heat pump|air source|ashp": {
                response: `💨 <b>Air Source Heat Pump Systems</b><br><br>
                Technical advantages:<br>
                ✅ Efficiency ratio up to 400%<br>
                ✅ 40% lower running costs than gas<br>
                ✅ 20+ years lifespan<br>
                ✅ Heating and cooling dual function<br><br>
                Government grants:<br>
                • BUS scheme grant £7,500<br>
                • Additional ECO4 funding<br>
                • 0% interest loan options<br><br>
                📞 Book your free technical assessment!`
            }
        };

        // Chat functionality
        let chatOpen = false;

        function toggleChat() {
            chatOpen = !chatOpen;
            const chatWindow = document.getElementById('chatWindow');
            const chatButton = document.querySelector('.chat-button');
            
            if (chatOpen) {
                chatWindow.style.display = 'flex';
                chatButton.style.display = 'none';
                document.getElementById('chatInput').focus();
            } else {
                chatWindow.style.display = 'none';
                chatButton.style.display = 'flex';
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Handle based on chat mode
            if (chatMode === 'openai' && apiKey) {
                await sendOpenAIMessage(message);
            } else {
                // Use basic chat mode
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    const response = getAIResponse(message);
                    addMessage(response, 'bot');
                }, 1000);
            }
        }

        async function sendOpenAIMessage(message) {
            const input = document.getElementById('chatInput');
            
            // Disable input while sending
            input.disabled = true;
            
            // Check if we're in booking flow
            if (isInBookingFlow && bookingHandler) {
                handleBookingFlow(message);
                input.disabled = false;
                input.focus();
                return;
            }

            // Check for booking intent
            if (bookingHandler && bookingHandler.detectBookingIntent(message)) {
                const response = bookingHandler.startBookingFlow();
                isInBookingFlow = true;
                addMessage(response.message, 'bot');
                input.disabled = false;
                input.focus();
                return;
            }

            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });

            // Show typing indicator
            showTyping();

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: conversationHistory,
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                // Add AI response to conversation history
                conversationHistory.push({ role: 'assistant', content: aiResponse });

                // Hide typing and add message
                hideTyping();
                addMessage(aiResponse, 'bot');

            } catch (error) {
                hideTyping();
                addMessage(`Error: ${error.message}. Please check your API key in settings.`, 'bot');
                console.error('OpenAI API Error:', error);
            } finally {
                // Re-enable input
                input.disabled = false;
                input.focus();
            }
        }

        function handleBookingFlow(message) {
            // Handle cancel commands
            if (message.toLowerCase() === 'cancel' || message.toLowerCase() === 'stop') {
                const response = bookingHandler.cancelBooking();
                isInBookingFlow = false;
                addMessage(response.message, 'bot');
                return;
            }

            // Process booking step
            const response = bookingHandler.processBookingStep(message);
            
            // Add response to chat
            addMessage(response.message, 'bot');
            
            // Check if booking is complete
            if (response.complete) {
                isInBookingFlow = false;
            }
        }

        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'bot') {
                // Format text for better display
                let formattedText = text;
                
                // Convert markdown links to HTML if in OpenAI mode
                if (chatMode === 'openai') {
                    formattedText = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea; text-decoration: underline;">$1</a>');
                    // Convert bold text
                    formattedText = formattedText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                    // Convert line breaks
                    formattedText = formattedText.replace(/\n/g, '<br>');
                }
                
                messageDiv.innerHTML = `
                    <div class="bot-avatar"><span>🤖</span></div>
                    <div class="message-content">${formattedText}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">${text}</div>
                `;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function getAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Search knowledge base
            for (const [keywords, data] of Object.entries(knowledgeBase)) {
                const keywordList = keywords.split('|');
                if (keywordList.some(keyword => lowerMessage.includes(keyword))) {
                    // Record user inquiry
                    saveUserInquiry(message);
                    return data.response;
                }
            }
            
            // Default response
            return `Thank you for your inquiry!<br><br>
            I can help you learn about:<br>
            • 🔥 Free heating grants<br>
            • ☀️ Solar panel installation<br>
            • 🏠 Home insulation services<br>
            • 💨 Air source heat pumps<br><br>
            Please select the service you're interested in, or call <b>07765556558</b> to speak with an expert.`;
        }

        function sendQuickReply(text) {
            document.getElementById('chatInput').value = text;
            sendMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function showTyping() {
            const messagesDiv = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Save user inquiry record
        function saveUserInquiry(message) {
            const inquiries = JSON.parse(localStorage.getItem('userInquiries') || '[]');
            inquiries.push({
                message: message,
                timestamp: new Date().toISOString(),
                url: window.location.href
            });
            localStorage.setItem('userInquiries', JSON.stringify(inquiries));
            
            console.log('User inquiry recorded:', message);
        }

        // Settings functions
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
            
            // Load saved settings
            const savedApiKey = localStorage.getItem('openai_api_key');
            const savedModel = localStorage.getItem('openai_model');
            const savedMode = localStorage.getItem('chat_mode') || 'basic';
            
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
            if (savedModel) {
                document.getElementById('model').value = savedModel;
            }
            
            selectChatMode(savedMode);
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function selectChatMode(mode) {
            // Update UI
            document.getElementById('basicMode').classList.toggle('active', mode === 'basic');
            document.getElementById('openaiMode').classList.toggle('active', mode === 'openai');
            
            // Show/hide API config
            const apiConfigSection = document.getElementById('apiConfigSection');
            if (mode === 'openai') {
                apiConfigSection.classList.add('active');
            } else {
                apiConfigSection.classList.remove('active');
            }
            
            // Store selected mode temporarily
            document.getElementById('settingsModal').dataset.selectedMode = mode;
        }

        function saveChatSettings() {
            const selectedMode = document.getElementById('settingsModal').dataset.selectedMode || 'basic';
            
            if (selectedMode === 'openai') {
                const apiKeyInput = document.getElementById('apiKey').value.trim();
                const modelInput = document.getElementById('model').value.trim();
                
                if (!apiKeyInput) {
                    alert('Please enter your OpenAI API key');
                    return;
                }
                
                if (!apiKeyInput.startsWith('sk-')) {
                    alert('Invalid API key format. It should start with "sk-"');
                    return;
                }
                
                // Save OpenAI settings
                apiKey = apiKeyInput;
                model = modelInput || 'gpt-4o-2024-08-06';
                localStorage.setItem('openai_api_key', apiKey);
                localStorage.setItem('openai_model', model);
                
                // Initialize conversation history
                conversationHistory = [
                    { role: 'system', content: systemPrompt }
                ];
            }
            
            // Update chat mode
            chatMode = selectedMode;
            localStorage.setItem('chat_mode', chatMode);
            
            // Update status indicator
            const statusText = chatMode === 'openai' ? '🧠 AI Mode' : '🟢 Basic Mode';
            document.getElementById('chatStatus').textContent = statusText;
            
            // Reset chat if switching modes
            if (chatMode === 'openai' && !apiKey) {
                alert('OpenAI API key is required for AI mode. Switching back to Basic mode.');
                chatMode = 'basic';
                localStorage.setItem('chat_mode', 'basic');
                document.getElementById('chatStatus').textContent = '🟢 Basic Mode';
            }
            
            // Close settings
            closeSettings();
            
            // Show success message in chat
            const modeMessage = chatMode === 'openai' 
                ? '✨ Switched to AI Mode (OpenAI). You can now ask complex questions and book meetings!' 
                : '💬 Switched to Basic Mode. Quick responses without API.';
            addMessage(modeMessage, 'bot');
        }

        // Show welcome message after page loads
        window.addEventListener('load', () => {
            // Load saved settings
            const savedApiKey = localStorage.getItem('openai_api_key');
            const savedModel = localStorage.getItem('openai_model');
            const savedMode = localStorage.getItem('chat_mode') || 'basic';
            
            if (savedApiKey) {
                apiKey = savedApiKey;
            }
            if (savedModel) {
                model = savedModel;
            }
            
            chatMode = savedMode;
            
            // Initialize OpenAI if API key exists
            if (chatMode === 'openai' && apiKey) {
                conversationHistory = [
                    { role: 'system', content: systemPrompt }
                ];
                document.getElementById('chatStatus').textContent = '🧠 AI Mode';
            }
            
            setTimeout(() => {
                // Auto-popup logic can be added here
            }, 3000);
        });

        // Close modal when clicking outside
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });
    </script>
</body>
</html>