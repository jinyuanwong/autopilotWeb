<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Eco Services - AI Chat with OpenAI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .config-panel {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
            margin: 20px;
        }

        .config-panel h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: transform 0.3s;
        }

        .btn-start:hover {
            transform: translateY(-2px);
        }

        .btn-start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            color: #27ae60;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .chat-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: none;
        }

        .chat-window {
            width: 380px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bot-message {
            display: flex;
            gap: 10px;
        }

        .bot-avatar {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .user-message {
            display: flex;
            justify-content: flex-end;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 14px;
            outline: none;
        }

        .send-button {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .info-box {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box h3 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box p {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Configuration Panel -->
    <div class="config-panel" id="configPanel">
        <h2>ü§ñ Configure OpenAI Chat</h2>
        
        <div class="info-box">
            <h3>‚ÑπÔ∏è How to get your API Key:</h3>
            <p>
                1. Go to <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a><br>
                2. Sign in or create an account<br>
                3. Click "Create new secret key"<br>
                4. Copy the key (starts with sk-)<br>
                5. Paste it below
            </p>
        </div>

        <div class="form-group">
            <label for="apiKey">OpenAI API Key:</label>
            <input type="password" id="apiKey" placeholder="sk-..." />
        </div>

        <div class="form-group">
            <label for="model">Model (optional):</label>
            <input type="text" id="model" value="gpt-4o-2024-08-06" placeholder="gpt-4o-2024-08-06 or gpt-4" />
        </div>

        <button class="btn-start" onclick="startChat()">Start Chat</button>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-window">
            <div class="chat-header">
                <div>
                    <h4>Planet Eco AI Assistant</h4>
                    <small>Powered by OpenAI</small>
                </div>
                <button onclick="closeChat()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <div class="bot-avatar">üå±</div>
                    <div class="message-content">
                        Hello! Welcome to Planet Eco Services üåç I'm here to help you with energy-efficient home improvements, government grants (ECO4 scheme), air source heat pumps, and insulation services. 
                        
                        How can I help you save energy and money today? You may be eligible for FREE grants up to ¬£12,000!
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot" style="animation-delay: 0.2s;"></div>
                <div class="typing-dot" style="animation-delay: 0.4s;"></div>
            </div>

            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script src="meeting-booking.js"></script>
    <script>
        let apiKey = '';
        let model = 'gpt-4o-2024-08-06';
        let conversationHistory = [];
        let bookingHandler = new MeetingBookingHandler();
        let isInBookingFlow = false;

        // System prompt for Planet Eco Services with comprehensive knowledge base
        const systemPrompt = `You are a helpful AI assistant for Planet Eco Services, a UK-based company specializing in energy-efficient home improvements.

COMPANY OVERVIEW:
- Mission: "Empower a Greener Future" and "positively impact the environment and provide convenience to people"
- Philosophy: Making sustainable choices accessible and convenient while creating positive environmental impact
- Contact: Phone (+44) 07765556558 | Email: info@planetecoservices.co.uk
- Address: Units 2 & 2A Hendham Vale Industrial Park, Vale Park Way, Crumpsall, Manchester M8 0AD
- Social Media: Facebook, YouTube (@PlanetEcoservices), Instagram (@planetecoservicesuk)

SERVICES OFFERED:

1. FREE CENTRAL HEATING GRANTS
- Helps enhance energy efficiency, reduce carbon emissions, and combat fuel poverty
- Benefits: Reduces heat loss, lowers energy bills, provides consistent warmth
- Application: Contact us ‚Üí Consultation ‚Üí Grant assistance ‚Üí Professional installation

2. AIR SOURCE HEAT PUMPS
- How they work: Extract heat from outside air using outdoor/indoor units with heat exchanger and compressor
- Efficiency: Up to 400% energy efficient
- Benefits: Year-round climate control, renewable heating, lower carbon footprint
- Funding: RHI grants up to ¬£12,000 available

3. INSULATION SERVICES:
a) Internal Wall Insulation
   - Applies insulation to interior surfaces of external walls
   - Benefits: Energy efficiency, comfort, noise reduction, preserves exterior appearance
   
b) Loft Insulation
   - Adds insulation between roof and ceiling
   - Benefits: Improved efficiency, reduced costs, enhanced comfort, soundproofing
   
c) Room in Roof Insulation
   - Transforms attic spaces into energy-efficient rooms
   - Benefits: Maximizes living space, improves efficiency, adds property value

ECO4 SCHEME DETAILS:
- Government initiative to improve energy efficiency and reduce fuel poverty
- NOT a loan - it's a government grant (free for eligible households)
- Objectives: Reducing fuel poverty, lowering carbon emissions, enhancing efficiency

ELIGIBILITY CRITERIA:
Qualifying Benefits Include:
- Income-based Jobseekers Allowance
- Income Support
- Pension Credit (Guarantee & Savings Credit)
- Universal Credit (income below threshold)
- Working Tax Credit
- Child Tax Credits
- Housing Benefit
- Income-related ESA

Property Requirements:
- Own or privately rent your home
- Property without previous gas heating system
- Income below certain threshold (varies by household size)

APPLICATION PROCESS:
1. Eligibility Check - Contact us or check online
2. Home Survey - Professional energy assessment
3. Installation - Qualified installers complete improvements
4. Follow-up support

RECENT UPDATES (Blog Topics):
- Boost Home Efficiency with UK Loft Insulation & Grants
- UK's Heat Pump Renewable Energy Scheme Overview
- Understanding Eco 4 Grant Scheme Eligibility
- Government Schemes for Central Heating

IMPORTANT FACTS:
- ECO4 is government-funded, NOT a loan
- Air source heat pumps eligible for RHI grants up to ¬£12,000
- Professional installation by qualified technicians
- Ongoing support and maintenance available
- Service coverage throughout the UK

When responding:
1. Be friendly, professional, and knowledgeable
2. Provide accurate information from our knowledge base
3. Encourage users to book free assessments
4. Share contact details when relevant
5. Explain eligibility clearly
6. Emphasize the free nature of grants (not loans)
7. Highlight environmental and financial benefits`;

        function startChat() {
            const apiKeyInput = document.getElementById('apiKey').value.trim();
            const modelInput = document.getElementById('model').value.trim();

            if (!apiKeyInput) {
                showError('Please enter your OpenAI API key');
                return;
            }

            if (!apiKeyInput.startsWith('sk-')) {
                showError('Invalid API key format. It should start with "sk-"');
                return;
            }

            apiKey = apiKeyInput;
            model = modelInput || 'gpt-4o-2024-08-06';

            // Initialize conversation with system prompt
            conversationHistory = [
                { role: 'system', content: systemPrompt }
            ];

            // Hide config panel and show chat
            document.getElementById('configPanel').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'block';
            showSuccess('Chat initialized successfully!');
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Disable input while sending
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;

            // Add user message to UI
            addMessage(message, 'user');
            input.value = '';

            // Check if we're in booking flow
            if (isInBookingFlow) {
                handleBookingFlow(message);
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
                return;
            }

            // Check for booking intent
            if (bookingHandler.detectBookingIntent(message)) {
                const response = bookingHandler.startBookingFlow();
                isInBookingFlow = true;
                hideTyping();
                addMessage(response.message, 'bot');
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
                return;
            }

            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });

            // Show typing indicator
            showTyping();

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: conversationHistory,
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                // Add AI response to conversation history
                conversationHistory.push({ role: 'assistant', content: aiResponse });

                // Hide typing and add message
                hideTyping();
                addMessage(aiResponse, 'bot');

            } catch (error) {
                hideTyping();
                addMessage(`Error: ${error.message}. Please check your API key and try again.`, 'bot');
                console.error('OpenAI API Error:', error);
            } finally {
                // Re-enable input
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }

        function handleBookingFlow(message) {
            // Handle cancel commands
            if (message.toLowerCase() === 'cancel' || message.toLowerCase() === 'stop') {
                const response = bookingHandler.cancelBooking();
                isInBookingFlow = false;
                addMessage(response.message, 'bot');
                return;
            }

            // Process booking step
            const response = bookingHandler.processBookingStep(message);
            
            // Add response to chat
            addMessage(response.message, 'bot');
            
            // Check if booking is complete
            if (response.complete) {
                isInBookingFlow = false;
            }
        }

        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            if (sender === 'bot') {
                // Convert markdown links to HTML
                let formattedText = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea; text-decoration: underline;">$1</a>');
                // Convert bold text
                formattedText = formattedText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                // Convert line breaks
                formattedText = formattedText.replace(/\n/g, '<br>');
                
                messageDiv.innerHTML = `
                    <div class="bot-avatar">üå±</div>
                    <div class="message-content">${formattedText}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">${text}</div>
                `;
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'flex';
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function closeChat() {
            document.getElementById('chatContainer').style.display = 'none';
            document.getElementById('configPanel').style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Load API key from localStorage if available
        window.addEventListener('load', () => {
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
        });

        // Save API key to localStorage when starting chat
        document.getElementById('apiKey').addEventListener('change', (e) => {
            if (e.target.value) {
                localStorage.setItem('openai_api_key', e.target.value);
            }
        });
    </script>
</body>
</html>